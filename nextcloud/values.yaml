##
## Nextcloud Helm Values for Ghostspy Homelab
## Kubernetes Domain: wyse.local
## Istio Sidecar Mode + External CNPG + External Redis
##

global:
  clusterDomain: wyse.local


## ----------------------------------------------------------
## NEXTCLOUD APPLICATION SETTINGS
## ----------------------------------------------------------
nextcloud:
  host: nextcloud.ghosthacker.dev       # <<< CHANGE TO YOUR PUBLIC FQDN
  username: admin                       # Initial admin user (created on first boot)
  password: changeme                    # CHANGE THIS
  updateStrategy: RollingUpdate

  ## Needed when behind Istio/Envoy
  extraEnvVars:
    - name: TRUSTED_PROXIES
      value: "10.0.0.0/8,192.168.0.0/16,172.16.0.0/12"
    - name: OVERWRITEHOST
      value: "nextcloud.ghosthacker.dev"   # <<< CHANGE TO YOUR FQDN
    - name: OVERWRITEPROTOCOL
      value: "https"
    - name: OVERWRITECLIURL
      value: "https://nextcloud.ghosthacker.dev"

## ----------------------------------------------------------
## EXTERNAL POSTGRESQL (CloudNativePG)
## ----------------------------------------------------------
externalDatabase:
  enabled: true
  type: postgresql
  host: nextcloud-db-rw.nextcloud.svc.wyse.local
  port: 5432
  database: nextcloud

  existingSecret:
    enabled: true
    secretName: nextcloud-db-secret
    usernameKey: username
    passwordKey: password


## ----------------------------------------------------------
## EXTERNAL REDIS (Bitnami Redis recommended)
## ----------------------------------------------------------
redis:
  enabled: true
  image:
    repository: redis
    tag: 8.0.5-bookworm # Example, use a specific version for stability
    pullPolicy: IfNotPresent
  auth:
    enabled: true
    existingSecret: nextcloud-redis-secret
    existingSecretPasswordKey: redis-password    
externalCache:
  enabled: true
  type: redis
  host: nextcloud-redis-master.nextcloud.svc.wyse.local
  port: 6379

  existingSecret:
    enabled: true
    secretName: nextcloud-redis-secret
    passwordKey: redis-password


## ----------------------------------------------------------
## PERSISTENCE SETTINGS
## ----------------------------------------------------------
persistence:
  enabled: true
  storageClass: rook-ceph-retain
  accessMode: ReadWriteOnce
  size: 50Gi


## ----------------------------------------------------------
## ISTIO SIDECAR CONFIGURATION
## ----------------------------------------------------------
## Ensures the pod receives sidecar injection properly
##
podAnnotations:
  sidecar.istio.io/inject: "true"

##
## Explicitly tell Envoy which ports to capture
##
podLabels:
  istio-injection: enabled

##
## Override local DNS search domain so services resolve as
## *.svc.wyse.local instead of *.svc.cluster.local
##
podDnsConfig:
  options:
    - name: local-search-domains
      value: "wyse.local"

dnsPolicy: ClusterFirst


## ----------------------------------------------------------
## INGRESS â€” DISABLED (handled by Istio Gateway)
## ----------------------------------------------------------
ingress:
  enabled: false


## ----------------------------------------------------------
## RESOURCES + REPLICAS
## ----------------------------------------------------------
replicaCount: 1

resources:
  requests:
    cpu: 100m
    memory: 512Mi
  limits:
    cpu: 2
    memory: 4Gi


## ----------------------------------------------------------
## APACHE CONFIG OVERRIDES (Required behind Envoy)
## ----------------------------------------------------------
apache:
  extraConfigs: |
    SetEnvIf X-Forwarded-Proto https HTTPS=on
